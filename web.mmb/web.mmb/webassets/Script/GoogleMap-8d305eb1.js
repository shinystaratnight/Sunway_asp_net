var GoogleMap=function(oMap,oOnMapClick,oOnZoomChanged,oOnBoundsChanged,oOnCentreChanged,sControlLayout){var me=this,bZoomChangedByUser=!1,bCentreChangedByUser=!1;me.MapObject,me.Map,me.Overlay,me.Markers=new Object,me.Icons=new Object,me.Geocoder,this.Setup=function(e,n,o,a,t,r){if(me.MapObject=int.f.SafeObject(e),null==me.MapObject&&window.location.toString().indexOf("localhost")>-1)return void alert("Please debug me: Could not set up the map correctly - could not get the requested map object");var s={mapTypeId:google.maps.MapTypeId.ROADMAP};r&&(s.mapTypeControl="Full"==r?!0:"None"==r?!1:void 0,s.overviewMapControl="Full"==r,s.panControl="Full"==r?!0:"None"==r?!1:void 0,s.rotateControl="Full"==r?!0:"None"==r?!1:void 0,s.scaleControl="Full"==r,s.streetViewControl="Full"==r?!0:"None"==r?!1:void 0,s.zoomControl="Full"==r?!0:"None"==r?!1:void 0,"Full"==r&&(s.zoomControlOptions={style:google.maps.ZoomControlStyle.LARGE})),me.Map=new google.maps.Map(me.MapObject,s),me.Overlay=new google.maps.OverlayView,me.Overlay.draw=function(){},me.Overlay.setMap(me.Map),me.Map.setCenter(new google.maps.LatLng(0,0)),me.MapObject.clientWidth&&me.Map.setZoom(1),bZoomChangedByUser=!0,bCentreChangedByUser=!0,n&&google.maps.event.addListener(me.Map,"click",function(e){n(e.latLng.lat(),e.latLng.lng())}),o&&google.maps.event.addListener(me.Map,"zoom_changed",function(){o(me.Map.getZoom(),bZoomChangedByUser)}),a&&google.maps.event.addListener(me.Map,"bounds_changed",function(){var e=me.Bounds();a(e.MinLat,e.MinLong,e.MaxLat,e.MaxLong,bZoomChangedByUser&&bCentreChangedByUser)}),t&&google.maps.event.addListener(me.Map,"center_changed",function(){var e=me.Centre();t(e.Lat,e.Long,bCentreChangedByUser)})},me.Setup(oMap,oOnMapClick,oOnZoomChanged,oOnBoundsChanged,oOnCentreChanged,sControlLayout),this.AddIcon=function(e,n,o,a,t,r,s,i){var g={anchor:new google.maps.Point(t,r),url:n,size:new google.maps.Size(o,a),origin:new google.maps.Point(s,i)},l={Name:e,GoogleMapIcon:g};return me.Icons[e]=l,g},this.ClearIcons=function(){me.Icons=new Object},this.AddMarker=function(e){me.AddMarker(e.Lat,e.Long,e.MarkerID,e.IconKey,e.OnClick,e.OnMouseOver,e.OnMouseOut,e.MinLat,e.MaxLat,e.MinLong,e.MaxLong,e.MarkerCount)},this.AddMarker=function(e,n,o,a,t,r,s,i,g,l,m,u){if((void 0==u||null==u)&&(u=1),!(Math.abs(e)>90||Math.abs(n)>180)){var M;M=void 0!=a&&null!=a?me.Icons[a].GoogleMapIcon:void 0;var d=new google.maps.LatLng(e,n),c=new google.maps.Marker({position:d,icon:M,zIndex:me.Markers.length});c.setMap(me.Map);var p={MinLat:i,MaxLat:g,MinLong:l,MaxLong:m},L={MarkerID:o,Marker:c,IconKey:a,ParentMap:me,Lat:e,Long:n,LatLong:d,Bounds:p,ClusterPrefix:null,MarkerCount:u,ShowInfoWindow:function(e){new google.maps.InfoWindow({content:e}).open(me.Map,L)}};return me.Markers[o]=L,t&&google.maps.event.addListener(c,"click",function(){t(L)}),r&&google.maps.event.addListener(c,"mouseover",function(){r(L)}),s&&google.maps.event.addListener(c,"mouseout",function(){s(L)}),L}},this.RemoveMarker=function(e){return e=me.SafeMarker(e),e.Marker.setMap(null),e.ParentMap=null,e},this.ClearMarkers=function(){for(var e in me.Markers)me.RemoveMarker(e);me.Markers=new Object},this.Build=function(bCentreAndZoom,sIcons,sEventDefs,sPoints){me.ClearIcons();for(var aIcons=sIcons.split("#"),i=0;i<aIcons.length;i++){var aIcon=aIcons[i].split(",");me.AddIcon(aIcon[0],aIcon[1],aIcon[3],aIcon[2],aIcon[4],aIcon[5])}for(var aEventDefs=new Array,aEvents=sEventDefs.split("#"),i=0;i<aEvents.length;i++){var aEvent=aEvents[i].split(",");aEventDefs[aEvent[0]]={OnClick:function(oMarker){eval(aEvent[1])(oMarker)},OnMouseOver:function(oMarker){eval(aEvent[2])(oMarker)},OnMouseOut:function(oMarker){eval(aEvent[3])(oMarker)}}}if(me.ClearMarkers(),""!=sPoints)for(var aPoints=sPoints.split("#"),aPoint,i=0;i<aPoints.length;i++)aPoint=aPoints[i].split(","),me.AddMarker(aPoint[1],aPoint[2],aPoint[0],aPoint[4],aEventDefs[aPoint[3]].OnClick,aEventDefs[aPoint[3]].OnMouseOver,aEventDefs[aPoint[3]].OnMouseOut,aPoint[5],aPoint[6],aPoint[7],aPoint[8]);bCentreAndZoom&&me.CentreAndZoom()},this.RemoveOutliers=function(e,n){void 0==e&&(e=3),void 0==n&&(n=5);for(var o=0;n>o;o++){var a=new Array;for(var t in me.Markers)oMarker=me.Markers[t],oMarker.ParentMap==me&&a.push(oMarker);for(var r=me.GetMeanGeographicalCoordinates(a),s=new google.maps.LatLng(r.Lat,r.Long),i=new Array,g=0,l=0;l<a.length;l++)i.push(google.maps.geometry.spherical.computeDistanceBetween(s,a[l].LatLong)),g+=i[l]*i[l];for(var m=Math.sqrt(g/a.length),u=!1,l=0;l<a.length;l++)i[l]>m*e&&(me.RemoveMarker(a[l]),u=!0);if(!u)break}},this.Cluster=function(e,n,o,a,t,r){void 0==t&&(r=0),void 0==r&&(r=1/0);var s,i=new Array,g=me.Bounds();for(var l in me.Markers)s=me.Markers[l],s.ParentMap==me&&(null==s.ClusterPrefix||s.ClusterPrefix==n)&&o(s)&&s.Lat>g.MinLat&&s.Lat<g.MaxLat&&s.Long>g.MinLong&&s.Long<g.MaxLong&&i.push(s);var m,u=parseInt(e),M=e.substring(u.toString().length);switch(M){case"px":var d,c,p,L,v=me.Overlay.getProjection();m=function(e,n){return d=v.fromLatLngToDivPixel(e.LatLong),c=v.fromLatLngToDivPixel(n.LatLong),p=Math.abs(d.x-c.x),L=Math.abs(d.y-c.y),Math.sqrt(p*p+L*L)<=u};break;case"pt":var d,c,p,L,v=me.Map.getProjection();m=function(e,n){return d=v.fromLatLngToPoint(e.LatLong),c=v.fromLatLngToPoint(n.LatLong),p=Math.abs(d.x-c.x),L=Math.abs(d.y-c.y),Math.sqrt(p*p+L*L)<=u};break;case"ml":m=function(e,n){return 621.371192*google.maps.geometry.spherical.computeDistanceBetween(e,n)<=u};break;case"km":m=function(e,n){return 1e3*google.maps.geometry.spherical.computeDistanceBetween(e,n)<=u};break;case"mt":m=function(e,n){return google.maps.geometry.spherical.computeDistanceBetween(e,n)<=u}}for(var h,f,C,k=new Array,y=new Array;h=i.pop();){f=new Array;for(var O=0;O<i.length;O++)f.length<r&&m(h,i[O])&&f.push(O);if(f.length>=t){C=new Array(h);for(var O=f.length-1;O>=0;O--)C.push(i[f[O]]),i.splice(f[O],1);k.push(C)}else y.push(h)}for(var l in me.Markers)0==l.indexOf(n)&&me.Markers[l].ParentMap==me&&me.RemoveMarker(l);for(var b,g,B,P,w,C,s,O=0;O<k.length;O++){C=k[O],b=a(n+O,C.length),g=new google.maps.LatLngBounds;for(var x=0;x<C.length;x++)s=C[x],g.extend(s.LatLong),null==s.ClusterPrefix&&(s.ClusterPrefix=n,s.Marker.setMap(null));B=me.GetMeanGeographicalCoordinates(C),P=g.getSouthWest(),w=g.getNorthEast(),me.AddMarker(B.Lat,B.Long,n+O,b.IconKey,b.OnClick,b.OnMouseOver,b.OnMouseOut,P.lat(),w.lat(),P.lng(),w.lng(),C.length)}for(var O=0;O<y.length;O++)s=y[O],s.ClusterPrefix==n&&(s.Marker.setMap(me.Map),s.ClusterPrefix=null);for(var l in me.Markers)s=me.Markers[l],null==s.ClusterPrefix&&(s.Lat<g.MinLat||s.Lat>g.MaxLat||s.Long<g.MinLong||s.Long>g.MaxLong)&&s.Marker.setMap(null),null==s.Marker.map&&null==s.ClusterPrefix&&s.Lat>=g.MinLat&&s.Lat<=g.MaxLat&&s.Long>=g.MinLong&&s.Long<=g.MaxLong&&s.Marker.setMap(me.Map)};var oSetCentre=function(e){bCentreChangedByUser=!1,me.Map.setCenter(e),bCentreChangedByUser=!0},oSetBounds=function(e,n){(void 0==n||null==n)&&(n=1/0);var o,a=function(){me.Map.getZoom()>n&&me.Map.setZoom(n),google.maps.event.removeListener(o),bCentreChangedByUser=!0,bZoomChangedByUser=!0};o=google.maps.event.addListener(me.Map,"bounds_changed",a),bCentreChangedByUser=!1,bZoomChangedByUser=!1,me.Map.fitBounds(e)};this.CentreAndZoom=function(e){google.maps.event.trigger(me.Map,"resize");var n,o=new google.maps.LatLngBounds;for(var a in me.Markers)n=me.Markers[a],n.ParentMap==me&&o.extend(n.LatLong);oSetBounds(o,e)},this.SetCentre=function(e,n){bCentreChangedByUser=!1,me.Map.setCenter(new google.maps.LatLng(e,n)),bCentreChangedByUser=!0},this.SetZoom=function(e){bZoomChangedByUser=!1,me.Map.setZoom(e),bZoomChangedByUser=!0},this.SetBounds=function(e,n,o,a,t){oSetBounds(new google.maps.LatLngBounds(new google.maps.LatLng(e,n),new google.maps.LatLng(o,a)),t)},this.PanToLocation=function(e,n,o){(void 0==o||null==o)&&(o=1/0),bCentreChangedByUser=!1,me.Map.panTo(new google.maps.LatLng(e,n)),bCentreChangedByUser=!0,me.Map.getZoom()>o&&me.SetZoom(o)},this.ZoomToMarker=function(e,n){if((void 0==n||null==n)&&(n=1/0),e=me.SafeMarker(e),google.maps.event.trigger(me.Map,"resize"),void 0==e.Bounds.MinLat||void 0==e.Bounds.MaxLat||void 0==e.Bounds.MinLong||void 0==e.Bounds.MaxLong)oSetCentre(e.LatLng),me.Map.getZoom()>n&&me.Map.SetZoom(n);else{var o=new google.maps.LatLngBounds(new google.maps.LatLng(e.Bounds.MinLat,e.Bounds.MinLong),new google.maps.LatLng(e.Bounds.MaxLat,e.Bounds.MaxLong));oSetBounds(o,n)}},this.SafeMarker=function(e){return"object"==typeof e?e:"string"==typeof e?me.Markers[e]:null},this.Bounds=function(){var e=me.Map.getBounds(),n=e.getSouthWest(),o=e.getNorthEast();return{MinLat:n.lat(),MinLong:n.lng(),MaxLat:o.lat(),MaxLong:o.lng()}},this.Centre=function(){var e=me.Map.getCenter();return{Lat:e.lat(),Long:e.lng()}},this.GetMarkerCoordinates=function(e){e=me.SafeMarker(e);var n=me.Overlay.getProjection().fromLatLngToContainerPixel(e.LatLong);return{x:n.x,y:n.y}},this.GetMarkerScreenPosition=function(e){var n=int.e.GetPosition(me.MapObject),o=me.GetMarkerCoordinates(e);return{left:n.Left+o.x,top:n.Top+o.y}},this.GetMeanGeographicalCoordinates=function(e){for(var n,o,a=0,t=0,r=0,s=0,i=0;i<e.length;i++)n=e[i].Lat,o=e[i].Long,0!=i&&(r=n-a/i),0!=i&&(s=o-t/i),r>90?n-=180:-90>r&&(n+=180),s>180?o-=360:-180>s&&(o+=360),a+=n,t+=o;var g=a/e.length,l=t/e.length;return g>90?g-=180:-90>g&&(g+=180),l>180?l-=360:-180>l&&(l+=360),{Lat:g,Long:l}},this.Search=function(e,n,o,a){(void 0==a||null==a)&&(a=!0),me.Geocoder||(me.Geocoder=new google.maps.Geocoder);var t=function(t,r){if(r==google.maps.GeocoderStatus.ZERO_RESULTS)return void(a?me.Search(e,n,o,!1):alert("Sorry, this location could not be found"));if(r==google.maps.GeocoderStatus.OVER_QUERY_LIMIT)return void alert("Sorry, the geocoding limit has been reached, please try again later");if(r!=google.maps.GeocoderStatus.OK)return void alert("Sorry, an error occured");var s=t[0];oSetBounds(s.geometry.viewport,o),n&&n(s.geometry.location.lat(),s.geometry.location.lng(),s.formatted_address)},r={address:e};a&&(r.bounds=me.Map.getBounds()),me.Geocoder.geocode(r,t)}};